<?xml version="1.0" encoding="UTF-8"?>
      <table xmlns="http://query.yahooapis.com/v1/schema/table.xsd"
xmlns:dcterms="http://purl.org/dc/terms/"
xmlns:sioc="http://rdfs.org/sioc/ns#">
    <meta>
        <author>Iker Azpeitia</author>
        <description>WordPress posts feed to LD</description>
        <documentationURL>https://codex.wordpress.org/WordPress_Feeds</documentationURL>
        <!--lowering-->
        <sampleQuery> URIPattern: http://rdf.onekin.org/wordpress/feed/{dcterms:identifier}/{wdrs:tag}</sampleQuery>
        <sampleQuery> URIExample: http://rdf.onekin.org/wordpress/feed/ikeronekin/sw</sampleQuery>
    </meta>
    <bindings>
          <select itemPath="results.*" produces="XML">
            <inputs>
		<key id="blogid" as="dcterms:identifier" type="xs:string" paramType="query" required="true" default="ikeronekin"/>
		<key id="tag" as="sioc:topic" type="xs:string" paramType="query" required="true" default="sw"/>
             </inputs>
             <execute> <![CDATA[
 var loweringselect = "env 'store://datatables.org/alltableswithkeys'; select * from feednormalizer where url=@blogfeed and output='atom_1.0'";
 var loweringparams ={};
 var blogfeed = "https://"+inputs['dcterms:identifier']+".wordpress.com/?tag="+inputs['sioc:topic']+"&feed=rss2";
 loweringparams ['blogfeed']= blogfeed;
 var loweringquery = y.query (loweringselect,loweringparams); 
 response.object =  loweringquery.results;
 ]]>
            </execute>
      </select>
 <function name="lifting">
  <inputs>
     <pipe id="oneXML" paramType="variable"/>
     <key id="URI" paramType="variable" required="true"/>
  </inputs>
 <execute><![CDATA[
try{
 var oneJSON= y.xmlToJson(oneXML);
	var oneJSONLD={};
	oneJSONLD['@id']=URI;
	oneJSONLD['@context']= {"sioc":"http://rdfs.org/sioc/ns#", "sioct": "http://rdfs.org/sioc/types#" ,"awol":"http://bblfish.net/work/atom-owl/2006-06-06/#"};
	oneJSONLD['@type']= [];
oneJSONLD['@type'].push ('awol:Feed');
oneJSONLD['@type'].push ('sioct:BlogPost');
oneJSONLD['awol:title'] = getValue("oneJSON['feed']['title']");
oneJSONLD['awol:link'] = getValue("oneJSON['feed']['link'][1]['href']");
oneJSONLD['awol:entry'] =[];
for (var LOOP4 = 0; LOOP4 < getLength(oneJSON['feed']['entry']); LOOP4++){
    var oneJSONLD3={};
    oneJSONLD3['@type']= 'awol:Entry';
    oneJSONLD3['@id']= getInterlink('http://rdf.onekin.org/wrodpress/post/{id}', getPostString ("=",getValue("oneJSON['feed']['entry'][LOOP4]['id']")));
    oneJSONLD3['sioc:content']= getValue("oneJSON['feed']['entry'][LOOP4]['title']");
    oneJSONLD3['dcterms:identifier']= getValue("oneJSON['feed']['entry'][LOOP4]['link']['href']");
    oneJSONLD3['sioc:topic']=[];
    for (var LOOP5 = 0; LOOP5 < getLength(oneJSON['feed']['entry'][LOOP4]['category']); LOOP5++){
      oneJSONLD3['sioc:topic'].push(getValue("oneJSON['feed']['entry'][LOOP4]['category'][LOOP5]['term']"));
    }
    oneJSONLD['awol:entry'].push(oneJSONLD3);
  }
}catch (err){ y.log(err);}
  response.object = oneJSONLD;

function getFromNode(nodePath, subNodePath) {
	try{return eval(dataPath) || null; }catch(err){return null;}}

function getInterlink (urlpattern, value){
	try{return value? urlpattern.replace(/{.*}/, value) : null;}catch(err){return null;}}

function getRegexpValue(regexp, value){
 	try{return value.match(regexp)[0];}catch(err){return null;}}

function getPostString(chars, value){
 	try{return value.substring(value.lastIndexOf(chars) + 1);}catch(err){return "";}}

function getValue(dataPath) {
	try{return eval(dataPath) || null; }catch(err){return null;}}

function getLength(obj) {
  	try{return getLength1(obj)==undefined? 0:getLength1(obj); }catch(err){return 0;}}

function getLength1(obj) {
  	try{return obj? obj.length: 0; }catch(err){return 0;}}

]]>
   </execute>
</function>
    </bindings> 
 </table>
