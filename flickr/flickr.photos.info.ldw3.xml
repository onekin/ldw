<?xml version="1.0" encoding="UTF-8"?>
      <table xmlns="http://query.yahooapis.com/v1/schema/table.xsd">
    <meta>
        <author>Iker Azpeitia</author>
        <description>Flickr photo info</description>
        <apiKeyURL>https://www.flickr.com/services/api/misc.api_keys.html</apiKeyURL>
        <!--lowering-->
        <sampleQuery> URIPattern: http://rdf.onekin.org/flickr.photos.info.ldw3/digitalphoto/{photo_id}</sampleQuery>
        <sampleQuery> URIExample: http://rdf.onekin.org/flickr.photos.info.ldw3/digitalphoto/2186714153</sampleQuery>
    </meta>
    <bindings>
        <select itemPath="results.*" produces="XML">
            <inputs>
		<key id="photo_id" type="xs:string" paramType="variable" required="true"/>
		<key id="api_key" type="xs:string" paramType="variable" required="true"  default="a8790b4372bdd655acfc66fcd4090e83"/>
             </inputs>
             <execute>
                <![CDATA[
 var loweringselect = "env 'store://datatables.org/alltableswithkeys'; select * from flickr.photos.info where photo_id=@photo_id and api_key = @api_key";
 var loweringparams ={};
 loweringparams ['photo_id']= photo_id;
loweringparams ['api_key']= api_key;
 var loweringquery = y.query (loweringselect,loweringparams); 
 response.object =  loweringquery.results;
 ]]>
            </execute>
      </select>
 <function name="lifting">
  <inputs>
     <pipe id="oneXML" paramType="variable"/>
     <key id="URI" paramType="variable" required="true"/>
  </inputs>
 <execute><![CDATA[
try{
 var oneJSON= y.xmlToJson(oneXML);
	var oneJSONLD={};
	oneJSONLD['@id']=URI;
	oneJSONLD['@context']= {"foaf":"http://xmlns.com/foaf/0.1/","dcterms":"http://purl.org/dc/terms/","dce":"http://purl.org/dc/elements/1.1/","iol":"http://www.ontologydesignpatterns.org/ont/dul/IOLite.owl"};
	oneJSONLD['@type']= 'iol:DigitalPhoto';
    
  oneJSONLD['foaf:page'] = getValue("oneJSON['photo']['url']");
  oneJSONLD['dcterms:type'] = getValue("oneJSON['photo']['media']");
  oneJSONLD['dce:format'] = getValue("oneJSON['photo']['originalformat']");
  oneJSONLD['iol:hasAuthor'] = getInterlink("oneJSON['photo']['owner']['nsid']", 'http://rdf.onekin.org/flickr.people.info2/{user_id}');
  oneJSONLD['dcterms:title'] = getValue("oneJSON['photo']['title']");
  oneJSONLD['dcterms:description'] = getValue("oneJSON['photo']['description']");
    oneJSONLD['dcterms:subject']=[];
  for (var LOOP4 = 0; LOOP4 < oneJSON['photo']['tags']['tag'].length; LOOP4++){
    oneJSONLD['dcterms:subject'].push (getValue("oneJSON['photo']['tags']['tag'][LOOP4]['content']"));
  }
     }catch (err){ y.log(err);}
    response.object = oneJSONLD;
    
    //interlink with regexp
function getRegexpInterlink (dataPath, urlpattern, regexp){
	return urlpattern.replace(/{.*}/, getRegexpValue(dataPath, regexp));}

//interlink without regexp
function getInterlink (dataPath, urlpattern){
	return urlpattern.replace(/{.*}/, getValue(dataPath));}

//direct mapping with regexp
function getRegexpValue(dataPath, regexp){
 	try{return getValue(dataPath).match(regexp)[0];}catch(err){return null;}}

//direct mapping without regexp
function getValue(dataPath) {
	try{return eval(dataPath) || null; }catch(err){return null;}}

function setArray(dataPath) {
  var begin=dataPath.indexOf(']',0)+1;
  beginnext = dataPath.indexOf(']',begin+1)
  while (begin>0 && beginnext>0){
    	var dPath = dataPath.substring(0,begin);
	var objs= getValue(dPath);  		
	if (objs=== null) {eval(dPath+'={};');}
	begin = dataPath.indexOf(']',begin+1)+1;
   	beginnext = dataPath.indexOf(']',begin+1)
  }
  var res = [];
  var objs= getValue(dataPath);
  if (objs=== null) {eval(dataPath+'=[];');}
  else {if (!objs[0]) {eval(dataPath+'=[];'+dataPath+'.push(objs);');}}
}
    ]]>
   </execute>
</function>
    </bindings> 
 </table>