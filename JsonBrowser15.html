<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:widget="http://www.netvibes.com/ns/">
    <head>

        <!-- Application Metas -->
        <title>Video and Photo Bookmarker by www.onekin.org</title>
        <meta name="author" content="www.onekin.org (Iker Azpeitia)" />
        <meta name="description" content="Schema.org VideoObject Bookmarking by www.onekin.org" />

        <!-- Application Standalone emulation files -->
        <link rel="stylesheet" type="text/css"
            href="http://uwa.netvibes.com/lib/c/UWA/assets/css/standalone.css" />
        <script type="text/javascript"
            src="http://uwa.netvibes.com/lib/c/UWA/js/UWA_Standalone_Alone.js"></script>

        <script type="text/javascript" src="http://code.highcharts.com/highcharts.js"></script>

        <!-- Application Preferences -->
        <widget:preferences>
            			<widget:preference name="uri" type="text" label="Deref URI" defaultValue="http://rdf.onekin.org/vimeo.video.ldw11/videoobject/4964539"/>
        </widget:preferences>

<!-- Application Source -->
<script type="text/javascript">
//<![CDATA[

    /*
        We create the global MyWidget object (it could be any other name).
        This object will be used to store variables and function.
    */
    var MyWidget = {

         plotchart: function (data,container) {

                var dimensions = MyWidget.getDimensions();

                // Clear body
                //widget.body.empty();

                // Inject chart in container
                MyWidget.chart = new Highcharts.Chart({
                    chart: {
                        defaultSeriesType: 'bar',
                        renderTo: container,//widget.body,
                        width: dimensions.width,
                        height: dimensions.height
                    },
                    title: {
                        text: 'Interactions'
                    },
                    tooltip: {
                        formatter: function () {
                            return this.series.name + ': ' + this.y;
                        }
                    },
                    plotOptions: {
                        bar: {
                            dataLabels: {
                                enabled: true
                            }
                        }
                    },
                    legend: {
                        layout: 'vertical',
                        align: 'right',
                        verticalAlign: 'top',
                        x: -10,
                        y: 0,
                        floating: true,
                        borderWidth: 1,
                        backgroundColor: '#FFFFFF',
                        shadow: true
                    },
                    credits: {
                        enabled: false
                    },
                    series: data
                });
            },

        getDimensions: function () {
            // Get Widget Viewport
            var dimensions = widget.getViewportDimensions(),
                minHeight = 200;
            return {
                width: dimensions.width,
                height: Math.max(200, minHeight)
            };
        },

        onResize: function () {

            if (MyWidget.chart) {

                // Get Widget Viewport
                var dimensions = MyWidget.getDimensions();

                MyWidget.chart.setSize(
                    dimensions.width,
                    200,//dimensions.height,
                    false
                );
            }
        },

                onLoad: function() {
					var uri = widget.getValue('uri');
                    MyWidget.urlCall(uri);
                },
				urlCall: function(url) {
                    widget.setValue('uri', url);
						UWA.Data.request(url, {
						         onComplete: MyWidget.onComplete,
						        onFailure: MyWidget.onFailure,
						       method: 'GET',
				        data: {   }  });
				},

        onComplete: function(json) {

                    var j = JSON.parse(json);
                    var name = j ['schema:name'];
                    var link = j ['schema:contentUrl'];
                    link = ' <a href="'+link+'"  style="color: #CC0000">'+name+'</a> ';
                    var description = j ['schema:description'];
                    var desc= link + '<br/>'+description;
                    var interaction = j ['schema:interactionStatistic'];
                    var txt= "<br/>";
 var data = [];

                    for (var k=0; k<interaction.length; k++){
                        var type = interaction[k]['schema:interactionType'];
                        type = type.replace("http://schema.org/","");
                        var count = parseInt(interaction[k]['schema:userInteractionCount']);
                        var inter= {};
                        var counta = [];
                        counta.push(count);
                        inter["name"]= type;
                        inter ["data"]=counta;
                        data.push(inter);
                    }
                    var url = j ['schema:thumbnailUrl'];
                    var html = '<img src="'+url+'" alt="'+url+'">';
//                    widget.setBody(desc+txt+html);
var container = widget.getElement('.chart');
var ldcontainer = widget.getElement('.lddata');
ldcontainer.innerHTML = desc+txt+html;
            MyWidget.plotchart(data, container);


                },
                onFailure: function(error) {
                    widget.setValue('uri', widget.getValue('uri'));
                     MyWidget.body ('Problem retrieving data. Error:  ' + error);
                }

    };

    /*
        The "onLoad" event is the very first event triggered when
        the widget is fully loaded or when the preferences are validated.

        Here, we add MyWidget.onLoad() function as "onLoad" event
        listener on the widget.
    */
    widget.addEvents({
        'onLoad': MyWidget.onLoad,
        'onResize': MyWidget.onResize
    });

//]]>
</script>


    </head>
    <body>
      <div class='lddata'>    Loading...  </div>
      <div class='chart'>   Loading... </div>
		</body>

</html>
